!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var i;i="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,i.DotaVisionSimulation=t()}}(function(){return function t(i,e,r){function n(a,s){if(!e[a]){if(!i[a]){var h="function"==typeof require&&require;if(!s&&h)return h(a,!0);if(o)return o(a,!0);var l=new Error("Cannot find module '"+a+"'");throw l.code="MODULE_NOT_FOUND",l}var d=e[a]={exports:{}};i[a][0].call(d.exports,function(t){var e=i[a][1][t];return n(e?e:t)},d,d.exports,t,i,e,r)}return e[a].exports}for(var o="function"==typeof require&&require,a=0;a<r.length;a++)n(r[a]);return n}({1:[function(t,i,e){function r(t){this.imagePath=t,this.image=null}r.prototype.load=function(t){var i=this;this.image=new Image,this.image.src=this.imagePath,this.image.onload=function(){i.canvas=document.createElement("canvas"),i.canvas.width=i.image.width,i.canvas.height=i.image.height,i.ctx=i.canvas.getContext("2d"),i.ctx.drawImage(i.image,0,0),t()}},r.prototype.scan=function(t,i,e,r,n){for(var o=this.ctx.getImageData(t,0,i,e),a=o.data,s=0;s<a.length;s+=4){var h=a[s],l=a[s+1],d=a[s+2],u=(a[s+3],Math.floor(s/4%i)),c=Math.floor(s/4/e);r(u,c,[h,l,d],n)}},i.exports=r},{}],2:[function(t,i,e){function r(t,i){return t>0&&i<0||!(i>0&&t<0)&&t<i}function n(t,i){return!r(t,i)}function o(t,i,e){return i<e?i<=t&&t<=e:i<=t&&t<=Math.PI||-Math.PI<=t&&t<=e}function a(t){return t>Math.PI?-(2*Math.PI-t):t<-Math.PI?2*Math.PI+t:t}function s(t,i){return t>0&&i<0?Math.abs(Math.PI-t-(-Math.PI-i)):i>0&&t<0?Math.abs(-t+i):t<=0&&i<=0?n(t,i)?-t+Math.PI-(-Math.PI-i):Math.abs(i-t):n(t,i)?Math.PI+(Math.PI-t)+i:Math.abs(i-t)}function h(t){for(var i=0,e=0;e<t.length;e++)i+=s(t[e][0],t[e][1]);return i}var l={DIRS:{4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]}};Number.prototype.mod=function(t){return(this%t+t)%t},Object.create||(Object.create=function(t){var i=function(){};return i.prototype=t,new i}),Function.prototype.extend=function(t){return this.prototype=Object.create(t.prototype),this.prototype.constructor=this,this},"undefined"!=typeof window&&(window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return setTimeout(t,1e3/60)},window.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||function(t){return clearTimeout(t)}),l.FOV=function(t,i){this._lightPasses=t,this._options={topology:8};for(var e in i)this._options[e]=i[e]},l.FOV.prototype.compute=function(t,i,e,r){},l.FOV.prototype._getCircle=function(t,i,e){var r,n,o,a=[];switch(this._options.topology){case 4:n=1,o=[0,1],r=[l.DIRS[8][7],l.DIRS[8][1],l.DIRS[8][3],l.DIRS[8][5]];break;case 6:r=l.DIRS[6],n=1,o=[-1,1];break;case 8:r=l.DIRS[4],n=2,o=[-1,1]}for(var s=t+o[0]*e,h=i+o[1]*e,d=0;d<r.length;d++)for(var u=0;u<e*n;u++)a.push([s,h]),s+=r[d][0],h+=r[d][1];return a},l.FOV.PreciseShadowcasting=function(t,i){l.FOV.call(this,t,i)},l.FOV.PreciseShadowcasting.extend(l.FOV),l.FOV.PreciseShadowcasting.prototype.compute=function(t,i,e,r){if(r(t,i,0,1),r(t-1,i-1,0,1),r(t,i-1,0,1),r(t+1,i-1,0,1),r(t-1,i,0,1),r(t+1,i,0,1),r(t-1,i+1,0,1),r(t,i+1,0,1),r(t+1,i+1,0,1),r(t-1,i-2,0,1),r(t,i-2,0,1),r(t+1,i-2,0,1),r(t-2,i-1,0,1),r(t-2,i,0,1),r(t-2,i+1,0,1),r(t+2,i-1,0,1),r(t+2,i,0,1),r(t+2,i+1,0,1),r(t-1,i+2,0,1),r(t,i+2,0,1),r(t+1,i+2,0,1),this._lightPasses(t,i))for(var n,o,s,h,l,d,u,c,f,g,p,w,v,m,y,_,M=[],x={},b=1;b<=e;b++){var I=this._getCircle(t,i,b),X=I.length;x={};for(var Y=0;Y<X;Y++){n=I[Y][0],o=I[Y][1];var k=n+","+o;if(_=this.walls[k],_&&"tree"==_[0]?(v=_[1],m=_[2],w=_[3]):(v=n,m=o,w=Math.SQRT2/2),u=v-t,c=m-i,f=Math.sqrt(u*u+c*c),f>.5)if(g=Math.asin(w/f),p=Math.atan2(c,u),h=a(p-g),l=a(p+g),s=!this._lightPasses(n,o),_&&"tree"==_[0])dx1=n-t,dy1=o-i,y=Math.sqrt(dx1*dx1+dy1*dy1),y<f&&(x[_[1]+","+_[2]]=[_[1],_[2]]),u=n-t,c=o-i,f=Math.sqrt(u*u+c*c),g=Math.asin(w/f),p=Math.atan2(c,u),h=a(p-g),l=a(p+g),d=this._checkVisibility(p,h,l,!1,M),d&&r(n,o,b,d);else if(d=this._checkVisibility(p,h,l,s,M),d&&r(n,o,b,d),this.done)return}for(var F in x)if(v=x[F][0],m=x[F][1],u=v-t,c=m-i,f=Math.sqrt(u*u+c*c),w=Math.SQRT2-.01,f>.5&&(g=Math.asin(w/f),p=Math.atan2(c,u),h=a(p-g),l=a(p+g),d=this._checkVisibility(p,h,l,!0,M),this.done))return}},l.FOV.PreciseShadowcasting.prototype._checkVisibility=function(t,i,e,r,n){for(var a=!r,s=0;s<n.length;s++){var h=n[s];if(o(t,h[0],h[1])){if(!r)return!1;a=!1}}return r&&(i<0&&e>=0?(this._mergeShadows(t,0,e,r,n),this.done=!1,this._mergeShadows(t,i,0,r,n)):this._mergeShadows(t,i,e,r,n),1!=n.length||o(i,n[0][0],n[0][1])&&o(e,n[0][0],n[0][1])||i==n[0][0]||e==n[0][1]||(this.done=!0)),a},l.FOV.PreciseShadowcasting.prototype._mergeShadows=function(t,i,e,n,a){for(var s=0,l=!1,d=0;s<a.length;){var u=a[s];if(d=s,o(i,u[0],u[1])){l=!0;break}if(s>0&&o(i,a[s-1][1],u[0])){l=!1;break}if(r(i,u[1])){if(r(i,u[0]))break;s++}else s++,d=s}for(var c=a.length-1,f=!1,g=0;c>=0;){var u=a[c];if(g=c,o(e,u[0],u[1])){f=!0;break}if(r(e,u[0]))c--,g=c;else{if(!r(e,u[1]))break;c--}}if(d==a.length&&!l&&0==g&&f&&(d=0),0==a.length)a.push([i,e]);else{var p=[l?a[d][0]:i,f?a[g][1]:e];g=Math.max(d,g);var w=h(a),v=!1;o(0,p[0],p[1])&&0!=p[0]&&0!=p[1]?(a.splice(d,d!=g||l!=f||l?g-d+1:0,[p[0],0]),0!=a[0][0]&&a[0][1]!=p[1]&&a.splice(d+1,0,[0,p[1]]),v=!0):a.splice(d,d!=g||l!=f||l?g-d+1:0,p);var m=h(a);if(m<w&&(this.done=!0),0==p[0]||v)for(var y=0;0!=a[0][0]&&(a.push(a.shift()),!(y>=a.length));)y++}},i.exports=l},{}],3:[function(t,i,e){function r(t){var i=t.split(",").map(function(t){return parseInt(t)});return{x:i[0],y:i[1]}}function n(t,i){return t+","+i}function o(t,i){return{x:t,y:i}}function a(t){return t.x+","+t.y}function s(t,i,e){for(var r=[],n=-1;n<=1;n++)for(var o=-1;o<=1;o++)if(0!==n||0!==o){var a=i+n+","+(e+o);t[a]&&r.push(t[a])}return r}function h(t,i){var e=[];for(var r in t){var n=t[r];if(n.z>i)for(var o=s(t,n.x,n.y),a=0;a<o.length;a++)if(o[a].z<=i){e.push(["wall",n.x,n.y,Math.SQRT2/2]);break}}return e}function l(t,i,e){for(var r=0;r<i[e].length;r++){var n=i[e][r];t[n[1]+","+n[2]]=n}}function d(t,i,e,r){e=e||"wall",r=r||Math.SQRT2/2;for(var n in i)t[n]=[e,i[n].x,i[n].y,r]}function u(t,i,e,r,n,o){for(var a in e)i<r[a]&&n[a]&&o[a].forEach(function(i){t[i.x+","+i.y]=["tree",e[a].x,e[a].y,Math.SQRT2]})}function c(t,i,e,r){function n(t,i,e,r,n){var o={};return t.scan(i,e,r,n,o),o}function o(t,i,e,r){var n=d.ImageXYtoGridXY(t,i);0===e[0]&&(r[n.x+","+n.y]=n)}function s(t,i,e,r){var n=d.ImageXYtoGridXY(t,i);n.z=e[0],r[n.x+","+n.y]=n,u.indexOf(e[0])==-1&&u.push(e[0])}function l(t,i,e,r){var n=d.ImageXYtoGridXY(t,i);if(0==e[1]&&0==e[2]){var o={x:n.x-.5,y:n.y-.5},s=e[0]+40,h=a(o);d.tree[h]=o,d.tree_elevations[h]=s,d.tree_blocks[h]=[],d.tree_state[h]=!0,[Math.floor,Math.ceil].forEach(function(t){[Math.floor,Math.ceil].forEach(function(i){var e={x:t(o.x),y:i(o.y)},r=a(e);d.tree_relations[r]=o,d.tree_blocks[h].push(e)})})}}var d=this;this.opts=r||{},this.gridnav=null,this.ent_fow_blocker_node=null,this.tools_no_wards=null,this.elevationGrid=null,this.elevationWalls={},this.tree={},this.tree_blocks={},this.tree_relations={},this.tree_elevations={},this.tree_state={},this.walls={},this.radius=this.opts.radius||parseInt(25),this.lights={},this.worldMinX=t.worldMinX,this.worldMinY=t.worldMinY,this.worldMaxX=t.worldMaxX,this.worldMaxY=t.worldMaxY,this.worldWidth=this.worldMaxX-this.worldMinX,this.worldHeight=this.worldMaxY-this.worldMinY,this.gridWidth=this.worldWidth/64+1,this.gridHeight=this.worldHeight/64+1,this.ready=!1,this.imageHandler=new f(i),this.imageHandler.load(function(){d.gridnav=n(d.imageHandler,2*d.gridWidth,d.gridWidth,d.gridHeight,o),d.ent_fow_blocker_node=n(d.imageHandler,3*d.gridWidth,d.gridWidth,d.gridHeight,o),d.tools_no_wards=n(d.imageHandler,4*d.gridWidth,d.gridWidth,d.gridHeight,o),d.elevationGrid=n(d.imageHandler,0,d.gridWidth,d.gridHeight,s),u.forEach(function(t){d.elevationWalls[t]=h(d.elevationGrid,t)}),n(d.imageHandler,d.gridWidth,d.gridWidth,d.gridHeight,l),d.ready=!0,e()});var u=[];this.lightPassesCallback=function(t,i){return!(t+","+i in d.walls)}}var f=t("./imageHandler.js"),g=t("./rot6.js");c.prototype.updateVisibility=function(t,i,e){var r=this,o=n(t,i),s=this.elevationGrid[o].z,h=new g.FOV.PreciseShadowcasting(this.lightPassesCallback,{topology:8});e=e||r.radius,this.walls={},l(this.walls,this.elevationWalls,s),d(this.walls,this.ent_fow_blocker_node),d(this.walls,this.tools_no_wards),u(this.walls,s,this.tree,this.tree_elevations,this.tree_state,this.tree_blocks),h.walls=this.walls,this.lights={},h.compute(t,i,e,function(o,h,l,d){var u=n(o,h),c=r.tree_relations[u],f=!1;if(c){var g=a(c);f=r.tree_state[g]&&r.tree_elevations[g]>s}1==d&&!r.ent_fow_blocker_node[u]&&!f&&(t-o)*(t-o)+(i-h)*(i-h)<e*e&&(r.lights[u]=255)})},c.prototype.isValidXY=function(t,i,e,r,o){var s=n(t,i),h=!1;if(o){var l=this.tree_relations[s];if(l){var d=a(l);h=this.tree_state[d]}}return!(!(t>=0&&t<this.gridWidth&&i>=0&&i<this.gridHeight)||e&&this.gridnav[s]||r&&this.tools_no_wards[s]||o&&h)},c.prototype.toggleTree=function(t,i){var e=n(t,i),r=!!this.tree_relations[e];if(r){var o=this.tree_relations[e],s=a(o);this.tree_state[s]=!this.tree_state[s]}return r},c.prototype.setRadius=function(t){this.radius=t},c.prototype.WorldXYtoGridXY=function(t,i,e){var r=(t-this.worldMinX)/64,n=(i-this.worldMinY)/64;return e||(r=parseInt(Math.round(r)),n=parseInt(Math.round(n))),{x:r,y:n}},c.prototype.GridXYtoWorldXY=function(t,i){return{x:64*t+this.worldMinX,y:64*i+this.worldMinY}},c.prototype.GridXYtoImageXY=function(t,i){return{x:t,y:this.gridHeight-i-1}},c.prototype.ImageXYtoGridXY=function(t,i){return{x:t,y:this.gridHeight-i-1}},c.prototype.WorldXYtoImageXY=function(t,i){var e=this.WorldXYtoGridXY(t,i);return this.GridXYtoImageXY(e.x,e.y)},c.prototype.key2pt=r,c.prototype.xy2key=n,c.prototype.xy2pt=o,c.prototype.pt2key=a,c.prototype.getAdjacentCells=s,i.exports=c},{"./imageHandler.js":1,"./rot6.js":2}]},{},[3])(3)});
